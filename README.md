# AstrBot 主动回复插件

一个支持聊天附带用户信息和定时主动发送消息的 AstrBot 插件。

## 功能特性

### 聊天附带用户信息
- 自动在 AI 对话中附加用户信息（用户名、用户ID）
- 自动附加当前时间信息
- 支持自定义时间格式
- 支持自定义信息模板
- **智能追加**：不会覆盖现有人格设置，而是追加到系统提示末尾

### 定时主动发送消息
- 定时向指定会话发送消息
- 支持多个消息模板随机选择
- 可配置发送间隔
- 支持活跃时间段设置
- 支持多会话管理

## 安装方法

1. 将插件文件放置到 AstrBot 的 `data/plugins/astrbot_proactive_reply/` 目录下
2. 重启 AstrBot 或在管理面板中重载插件
3. 在管理面板的插件管理中配置相关参数

## 配置文件位置

- **插件配置文件**：`data/config/astrbot_proactive_reply_config.json`
- **配置模式文件**：`data/plugins/astrbot_proactive_reply/_conf_schema.json`

**提示**：
- 推荐通过 AstrBot 管理面板进行配置，会自动生成和保存配置文件
- 如需手动编辑配置，请参考 `_conf_schema.json` 中的配置结构
- 配置修改后需要重载插件才能生效

## 配置说明

### 用户信息附加设置
- **时间格式**：时间显示格式（Python datetime 格式）
- **信息模板**：用户信息的显示模板，支持占位符。会追加到现有系统提示末尾，不会覆盖人格设置

### 定时主动发送设置
- **启用功能**：是否启用定时主动发送消息功能
- **发送间隔**：每隔多少分钟发送一次消息
- **消息模板**：消息模板列表，每行一个，发送时随机选择
- **目标会话**：需要发送消息的会话列表
- **活跃时间**：只在指定时间段内发送消息

## 使用指南

### 基本指令

```
/proactive help          # 显示帮助信息
/proactive status        # 查看插件状态
/proactive debug         # 调试用户信息，查看AI收到的信息
/proactive test_llm      # 测试LLM请求，实际体验用户信息附加功能
/proactive add_session   # 将当前会话添加到定时发送列表
/proactive remove_session # 将当前会话从定时发送列表移除
/proactive test          # 测试发送一条主动消息
```

### 快速开始

1. **配置用户信息模板**：
   - 用户信息功能始终启用
   - 在管理面板中自定义信息模板
   - 通过模板控制显示哪些信息（用户名、ID、时间等）

2. **设置定时主动发送**：
   - 在管理面板中启用"定时主动发送功能"
   - 设置发送间隔和活跃时间
   - 配置消息模板
   - 使用 `/proactive add_session` 添加当前会话到发送列表

3. **测试功能**：
   - 使用 `/proactive debug` 查看AI收到的用户信息
   - 使用 `/proactive test_llm` 实际测试用户信息附加功能
   - 使用 `/proactive test` 测试主动消息发送
   - 使用 `/proactive status` 查看插件状态

## 配置示例

### 用户信息模板示例

**默认模板**（推荐）：
```
[对话信息] 用户：{username}，时间：{time}
```

**详细信息模板**：
```
[对话信息] 用户：{username}（ID：{user_id}），时间：{time}，平台：{platform}（{chat_type}）
```

**最简模板**（只显示用户名）：
```
用户：{username}
```

**重要提示**：
- 用户信息会追加到现有系统提示的末尾，不会覆盖您设置的人格
- 建议保持模板简洁，避免与人格设置产生冲突
- 不想显示某项信息？直接从模板中删除对应的占位符即可！

### 消息模板示例
```
"嗨，最近怎么样？"
"有什么我可以帮助你的吗？"
"好久不见，有什么新鲜事吗？"
"今天过得如何？"
"有什么想聊的吗？"
```

## 测试指南

### 如何测试用户信息附加功能

1. **查看调试信息**：
   ```
   /proactive debug
   ```
   这个指令会显示：
   - 当前用户的原始信息（昵称、ID等）
   - 插件配置状态
   - AI将收到的完整用户信息

2. **实际测试LLM请求**：
   ```
   /proactive test_llm
   ```
   这个指令会：
   - 发送一个测试消息给AI
   - 自动附加用户信息
   - 让您直接体验功能效果

3. **查看日志**：
   在AstrBot日志中查看详细的用户信息添加过程

### 如何测试定时主动发送功能

1. **添加当前会话**：
   ```
   /proactive add_session
   ```

2. **测试立即发送**：
   ```
   /proactive test
   ```

3. **查看状态**：
   ```
   /proactive status
   ```

## 与 AstrBot 系统的兼容性

### 人格系统兼容
- **不会覆盖人格设置**：用户信息追加到系统提示末尾，保持现有人格完整性
- **支持所有人格**：无论使用默认人格还是自定义人格，都能正常工作
- **智能追加机制**：自动检测现有系统提示，避免冲突

### 对话管理兼容
- **保持对话连续性**：不影响 AstrBot 的对话管理功能
- **支持多会话**：每个会话的用户信息独立处理
- **历史记录完整**：不影响对话历史的存储和检索

## 技术特性

- 完全符合 AstrBot 插件开发规范
- 使用官方 API，无任何非标准功能
- 支持异步处理和错误恢复
- 完整的日志记录和调试功能
- 优雅的资源清理
- **人格系统友好**：智能追加，不覆盖现有设置

## 开发信息

- **作者**：AstraSolis
- **版本**：v1.0.0
- **许可证**：[LICENSE](LICENSE)
- **项目地址**：https://github.com/AstraSolis/astrbot_proactive_reply
- **更新日志**：[CHANGELOG.md](CHANGELOG.md)

## 问题反馈

如果您在使用过程中遇到问题，请在 [GitHub Issues](https://github.com/AstraSolis/astrbot_proactive_reply/issues) 中反馈。

## 贡献

欢迎提交 Pull Request 来改进这个插件！
