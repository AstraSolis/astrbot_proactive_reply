# 更新日志

所有重要的项目变更都会记录在这个文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [v1.0.0] - 2025-01-22 (更新)

### 🔥 重大改进
- **解决AI主动消息上下文断裂问题**：AI主动发送的消息现在会自动添加到对话历史记录中
  - 用户下次发消息时，LLM能够看到AI之前主动发送的内容，保持对话连贯性
  - 自动处理对话创建和历史记录解析
  - 使用高效的SQL直接更新方式保存到数据库

### 新增功能
- 新增 `add_message_to_conversation_history()` 方法，专门处理对话历史记录
- 新增 `/proactive test_conversation_history` 指令，用于测试对话历史记录功能
- 新增调试工具：`debug_conversation_object`、`debug_database`、`debug_db_schema`

### 技术改进
- 优化对话历史的JSON格式处理
- 识别正确的数据库表结构（`webchat_conversation`表）
- 使用最优的SQL直接更新方式
- 简化代码结构，提高性能和可维护性
- 增强错误处理和日志记录

### 问题修复
- 🐛 修复AI主动发送消息不进入历史记录导致的上下文断裂问题
- 🐛 优化数据库操作，确保消息可靠保存

## [v1.0.0] - 2025-07-22

### 重大更新
- **智能主动对话系统**：完全重构主动消息生成机制
  - 移除预设消息模板，改为基于LLM的智能生成
  - 支持AstrBot人格系统兼容，自动组合人格提示词与主动对话指令
  - 新增主动对话默认人格配置，当无AstrBot人格时使用
  - 实现主动对话提示词列表，支持随机选择不同的对话风格
  - 基于用户信息和对话历史的上下文感知生成

### 配置界面优化
- **列表配置格式**：配置项改为可视化列表管理
  - 主动对话提示词列表：每个提示词可单独添加、编辑、删除
  - 目标会话列表：每个会话ID可单独管理
  - 支持拖拽排序和批量操作
  - 提供直观的用户界面，类似其他AstrBot配置项

### 新增功能
- 初始版本发布
- 实现聊天附带用户信息功能
  - 自动获取用户昵称、用户ID、时间信息
  - 支持自定义时间格式
  - 支持自定义信息模板
  - 智能追加到系统提示，不覆盖人格设置
  - 自动记录用户消息时间用于占位符
- 实现定时主动发送消息功能
  - 支持多会话管理
  - 支持多消息模板随机选择
  - **双时间模式支持**：
    - 固定间隔模式：传统的固定时间间隔，可选随机延迟
    - 随机间隔模式：完全随机的时间间隔（配置范围内随机）
  - 支持活跃时间段设置
  - 支持引号格式的消息模板解析
  - 消息模板支持时间占位符
- 占位符系统
  - 消息模板占位符：`{time}`, `{last_sent_time}`, `{user_last_message_time}`
  - 用户信息模板占位符：`{username}`, `{user_id}`, `{time}`, `{platform}`, `{chat_type}`
  - **主动对话提示词占位符**：支持细粒度的占位符定制
    - `{user_context}` - 完整的用户上下文信息（向后兼容）
    - `{user_last_message_time}` - 用户上次主动发送消息的时间
    - `{user_last_message_time_ago}` - 用户上次主动发送消息的相对时间（如"5分钟前"）
    - `{username}` - 用户昵称
    - `{platform}` - 平台名称（如：aiocqhttp、telegram等）
    - `{chat_type}` - 聊天类型（群聊/私聊）
    - `{ai_last_sent_time}` - AI上次发送消息的时间
    - `{current_time}` - 当前时间
- 提供完整的管理指令系统
  - `/proactive status` - 查看插件状态
  - `/proactive current_session` - 显示当前会话ID和状态
  - `/proactive add_session` - 添加当前会话到定时发送列表
  - `/proactive remove_session` - 移除当前会话
  - `/proactive test` - 测试主动消息发送
  - `/proactive restart` - 重启定时任务
  - `/proactive debug` - 调试用户信息
  - `/proactive test_llm` - 测试LLM请求
  - `/proactive test_llm_generation` - 测试LLM生成主动消息功能
  - `/proactive test_prompt` - 测试系统提示词构建过程
  - `/proactive test_placeholders` - 测试占位符替换功能
  - `/proactive show_user_info` - 显示记录的用户信息
  - `/proactive clear_records` - 清除记录数据
  - `/proactive task_status` - 检查定时任务状态
  - `/proactive debug_send` - 调试定时发送功能
  - `/proactive debug_config` - 调试配置文件持久化状态
  - `/proactive debug_persistent` - 调试独立持久化文件状态
  - `/proactive force_save_config` - 强制保存配置文件
  - `/proactive force_start` - 强制启动定时任务
  - `/proactive config` - 显示完整配置
  - `/proactive help` - 显示帮助信息

### 技术特性
- 完全符合 AstrBot 插件开发规范
- 使用官方 API，无任何非标准功能
- 支持异步处理和错误恢复
- 完整的日志记录和调试功能
- 优雅的资源清理和任务管理
- **人格系统深度集成**：自动检测并组合AstrBot人格与主动对话指令
- **智能LLM调用**：使用底层LLM API生成个性化主动消息
- **多格式配置解析**：支持列表、JSON、传统换行格式的自动识别
- 自动配置检查和补充机制
- 安全的占位符替换机制
- 强化的定时任务停止机制
- 详细的调试和诊断工具
- **智能时间模式切换**：支持固定间隔和随机间隔两种模式
- **配置参数智能提示**：每个配置项明确标注适用模式
- **向后兼容性保证**：现有配置无需修改即可正常使用
- **可视化配置管理**：支持现代化的列表配置界面
- **强化配置持久化**：改进配置保存机制，确保用户信息在重启后不丢失
  - **双重持久化机制**：同时保存到配置文件和独立持久化文件
  - **自动数据恢复**：启动时自动从持久化文件恢复数据，避免配置重置影响
  - **多重保存机制**：正常保存失败时自动尝试强制保存
  - **配置加载验证**：启动时验证已保存的用户信息
  - **详细的保存日志**：记录每次配置保存的结果
  - **调试工具**：提供配置持久化状态检查和强制保存功能
  - **编码兼容性**：自动处理UTF-8 BOM等编码问题，支持多种编码格式读取配置文件

### 兼容性
- 与 AstrBot 人格系统完全兼容
- 与 AstrBot 对话管理系统完全兼容
- 支持所有 AstrBot 支持的消息平台
- 支持可视化配置管理

---

## 版本说明

### 版本号格式
本项目使用语义化版本号：`主版本号.次版本号.修订号`

- **主版本号**：不兼容的 API 修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

### 更新类型
- **新增功能** - 新的功能特性
- **改进** - 对现有功能的改进
- **修复** - 错误修复
- **变更** - 可能影响兼容性的变更
- **移除** - 移除的功能
- **安全** - 安全相关的修复

---

## 贡献指南

如果您想为项目贡献代码或报告问题，请：

1. 在 [GitHub Issues](https://github.com/AstraSolis/astrbot_proactive_reply/issues) 中报告问题
2. 提交 Pull Request 时请详细说明变更内容
3. 确保新功能有相应的测试和文档

感谢您的贡献！
